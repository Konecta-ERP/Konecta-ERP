<div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-2 flex flex-column p-4">
    <div class="max-w-6xl w-full mx-auto flex flex-column flex-grow-1">
        <!-- Header -->
        <div class="flex align-items-center gap-2 mb-3">
            <p-button
                icon="pi pi-arrow-left"
                [text]="true"
                [rounded]="true"
                size="small"
                (onClick)="goBack()"
            ></p-button>
            <h1 class="text-2xl font-bold text-900 m-0">Job Post Management</h1>
        </div>

        <!-- Job Post Card -->
        @if(isViewMode && jobPost && requisition) {
        <p-card class="mb-2 shadow-4 border-round-2xl flex-shrink-0">
            <ng-template pTemplate="header">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-3 border-round-top-2xl">
                    <div class="flex align-items-center justify-content-between">
                        <div>
                            <h2 class="text-white text-xl font-bold m-0">{{ jobPost.title }}</h2>
                            <p class="text-blue-100 text-sm m-0 mt-0">
                                Requisition #{{ requisition.id }}
                            </p>
                        </div>
                        <p-tag
                            [value]="jobPost.active ? 'Active' : 'Inactive'"
                            [severity]="jobPost.active ? 'success' : 'secondary'"
                        ></p-tag>
                    </div>
                </div>
            </ng-template>

            <div class="grid gap-2">
                <!-- Top Row: Reason, Priority, Openings -->
                <div class="col-12">
                    <div class="flex gap-6 align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-600 font-semibold text-sm m-0 mb-0">Reason</p>
                            <p class="text-900 text-sm m-0">
                                {{ requisition.reason }}
                            </p>
                        </div>
                        <div>
                            <p class="text-600 font-semibold text-sm m-0 mb-0">Priority</p>
                            <p-tag
                                [value]="requisition.priority"
                                [severity]="
                                    requisition.priority === 'HIGH'
                                        ? 'danger'
                                        : requisition.priority === 'MEDIUM'
                                        ? 'warn'
                                        : 'info'
                                "
                            ></p-tag>
                        </div>
                        <div>
                            <p class="text-600 font-semibold text-sm m-0 mb-0">Openings</p>
                            <p class="text-900 font-semibold text-center text-sm pt-2">
                                {{ requisition.openings }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="col-12">
                    <p class="text-600 font-semibold text-sm m-0 mb-0">
                        <i class="pi pi-book mr-1"></i>Description
                    </p>
                    <p class="text-900 text-sm line-height-1_5 m-0">{{ jobPost.description }}</p>
                </div>

                <!-- Requirements -->
                <div class="col-12">
                    <p class="text-600 font-semibold text-sm m-0 mb-1">
                        <i class="pi pi-list mr-1"></i>Requirements
                    </p>
                    <div class="flex flex-wrap gap-2">
                        @for(requirement of jobPost.requirements; track $index) {
                        <p-tag
                            [value]="requirement.text + (requirement.mandatory ? ' *' : '')"
                            [severity]="'info'"
                            class="text-xs"
                        ></p-tag>
                        }
                    </div>
                </div>

                <!-- Posted Date & Action Button -->
                <div class="col-12">
                    <div class="flex align-items-center justify-content-between">
                        <div>
                            <p class="text-600 text-xs m-0 mb-0">Posted</p>
                            <p class="text-900 text-sm m-0">{{ formatDate(jobPost.postedAt) }}</p>
                        </div>
                        <p-button
                            [label]="jobPost.active ? 'Deactivate' : 'Activate'"
                            [severity]="jobPost.active ? 'danger' : 'success'"
                            icon="pi pi-power-off"
                            size="small"
                            (onClick)="toggleJobPostActive()"
                        ></p-button>
                    </div>
                </div>
            </div>
        </p-card>

        <!-- Applicants Kanban Board -->
        @if(isViewMode && jobPost && applicants.length > 0) {
        <p-card class="mt-3 shadow-4 border-round-2xl flex-grow-1 flex flex-column">
            <ng-template pTemplate="header">
                <div
                    class="bg-gradient-to-r from-green-600 to-emerald-600 p-3 border-round-top-2xl flex align-items-center justify-content-between"
                >
                    <h2 class="text-white text-xl font-bold m-0">
                        <i class="pi pi-users mr-2"></i>Applicants Pipeline ({{
                            applicants.length
                        }})
                    </h2>
                    <!-- Trash Drop Zone -->
                    <div
                        class="bg-white border-2 border-solid border-red-500 border-round-lg p-3 cursor-pointer flex align-items-center justify-content-center"
                        style="width: 50px; height: 50px"
                        [class.bg-red-700]="dragOverStatus === 'TRASH'"
                        [class.scale-120]="dragOverStatus === 'TRASH'"
                        [class.transition-all]="dragOverStatus === 'TRASH'"
                        [class.duration-200]="dragOverStatus === 'TRASH'"
                        (dragover)="onDragOver($event, 'TRASH')"
                        (dragleave)="onDragLeave()"
                        (drop)="onDrop($event, 'TRASH')"
                        pTooltip="Drag applicant here to delete"
                        tooltipPosition="left"
                    >
                        <i class="pi pi-trash text-red-500 text-xl"></i>
                    </div>
                </div>
            </ng-template>

            <!-- Kanban Board -->
            <div class="flex gap-3 pb-2 flex-grow-1">
                @for(status of kanbanStatuses; track status) {
                <div style="width: 320px; display: flex; flex-direction: column">
                    <!-- Column Header -->
                    <div class="bg-200 p-3 border-round-lg mb-2">
                        <div class="flex align-items-center justify-content-between">
                            <h3 class="text-900 font-semibold text-sm m-0">
                                {{ status }}
                                <span class="text-600 text-xs ml-2">
                                    ({{ applicantsByStatus[status].length }})
                                </span>
                            </h3>
                            <i class="pi pi-ellipsis-v text-600 text-sm"></i>
                        </div>
                    </div>

                    <!-- Dropzone for Applicants -->
                    <div
                        class="bg-50 border-2 border-dashed border-300 border-round-lg p-2 overflow-y-auto flex-grow-1"
                        [class.bg-yellow-50]="dragOverStatus === status"
                        [class.border-yellow-300]="dragOverStatus === status"
                        (dragover)="onDragOver($event, status)"
                        (dragleave)="onDragLeave()"
                        (drop)="onDrop($event, status)"
                    >
                        @if(applicantsByStatus[status].length > 0) { @for(applicant of
                        applicantsByStatus[status]; track applicant.id) {
                        <div
                            class="bg-white p-2 border-round-lg mb-2 shadow-1 cursor-move hover:shadow-3 transition-all duration-200"
                            style="height: 140px; display: flex; flex-direction: column"
                            draggable="true"
                            (dragstart)="onDragStart($event, applicant)"
                            (dragend)="onDragEnd()"
                        >
                            <!-- Applicant Card -->
                            <div class="flex-grow-1">
                                <p class="text-700 font-semibold text-xs m-0 mb-0 text-truncate">
                                    <i class="pi pi-user text-600 text-xs mr-1"></i>
                                    {{ applicant.firstName }} {{ applicant.lastName }}
                                </p>
                                <a
                                    [href]="'mailto:' + applicant.email"
                                    class="text-primary text-xs block m-0 mb-1 line-height-1_5 text-truncate"
                                >
                                    {{ applicant.email }}
                                </a>
                                <small class="text-600 text-xs">
                                    Applied: {{ formatDate(applicant.appliedAt) }}
                                </small>
                            </div>
                            <div class="flex gap-1 mt-1">
                                <p-button
                                    icon="pi pi-download"
                                    [text]="true"
                                    [rounded]="true"
                                    severity="info"
                                    size="small"
                                    (onClick)="downloadCv(applicant.id, applicant.cvFileName)"
                                    pTooltip="Download CV"
                                    tooltipPosition="top"
                                ></p-button>
                                <p-button
                                    icon="pi pi-file-pdf"
                                    [text]="true"
                                    [rounded]="true"
                                    severity="warn"
                                    size="small"
                                    (onClick)="showCoverLetter(applicant)"
                                    pTooltip="View Cover Letter"
                                    tooltipPosition="top"
                                ></p-button>
                            </div>
                        </div>
                        } } @else {
                        <div class="text-center py-6">
                            <i class="pi pi-inbox text-400 text-2xl mb-2 block"></i>
                            <p class="text-600 text-xs">No applicants</p>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </p-card>
        } @else if(isViewMode && jobPost && applicants.length === 0) {
        <p-card class="mt-6 shadow-4 border-round-2xl">
            <ng-template pTemplate="header">
                <div class="bg-gradient-to-r from-gray-600 to-slate-600 p-5 border-round-top-2xl">
                    <h2 class="text-white text-2xl font-bold m-0">
                        <i class="pi pi-users mr-2"></i>Applicants
                    </h2>
                </div>
            </ng-template>
            <div
                class="flex flex-column align-items-center justify-content-center py-8 px-4 text-center"
            >
                <i class="pi pi-inbox text-6xl text-400 mb-4"></i>
                <p class="text-600 text-lg">No applicants yet for this job post</p>
            </div>
        </p-card>
        } } @else if(!isLoading && !jobPost) {
        <!-- Create Job Post Card -->
        <p-card class="shadow-4 border-round-2xl">
            <ng-template pTemplate="header">
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-5 border-round-top-2xl">
                    <h2 class="text-white text-2xl font-bold m-0">Create Job Post</h2>
                </div>
            </ng-template>

            <div
                class="flex flex-column align-items-center justify-content-center py-8 px-4 text-center"
            >
                <div
                    class="bg-purple-50 border-circle w-8rem h-8rem flex align-items-center justify-content-center mb-4"
                >
                    <i class="pi pi-briefcase text-6xl text-purple-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-900 mb-2">No Job Post Yet</h3>
                <p class="text-600 text-lg mb-4 max-w-30rem">
                    Create a job post to publish this requisition and start recruiting candidates.
                </p>
                <p-button
                    label="Create Job Post"
                    icon="pi pi-plus"
                    severity="success"
                    (onClick)="openCreateModal()"
                ></p-button>
            </div>
        </p-card>
        }

        <!-- Loading State -->
        @if(isLoading) {
        <div class="flex align-items-center justify-content-center py-8">
            <i class="pi pi-spin pi-spinner text-primary text-4xl"></i>
        </div>
        }
    </div>

    <!-- Cover Letter Modal -->
    <p-dialog
        [(visible)]="showCoverLetterModal"
        [header]="'Cover Letter'"
        [modal]="true"
        [style]="{ width: '90vw', maxWidth: '600px' }"
        [draggable]="false"
        [resizable]="false"
        (onHide)="closeCoverLetterModal()"
    >
        <div class="space-y-3">
            <div>
                <p class="text-600 font-semibold text-sm m-0 mb-2">Applicant</p>
                <p class="text-900 text-sm m-0">
                    {{ selectedApplicant?.firstName }} {{ selectedApplicant?.lastName }}
                </p>
            </div>
            <div>
                <p class="text-600 font-semibold text-sm m-0 mb-2">Email</p>
                <a [href]="'mailto:' + selectedApplicant?.email" class="text-primary text-sm">
                    {{ selectedApplicant?.email }}
                </a>
            </div>
            <div>
                <p class="text-600 font-semibold text-sm m-0 mb-2">Cover Letter</p>
                <p class="text-900 text-sm line-height-1_6 whitespace-pre-wrap m-0">
                    {{ selectedApplicant?.coverLetter }}
                </p>
            </div>
        </div>
    </p-dialog>

    <!-- Create Job Post Modal -->
    <p-dialog
        [(visible)]="showCreateModal"
        [header]="'Create Job Post'"
        [modal]="true"
        [style]="{ width: '90vw', maxWidth: '700px' }"
        [draggable]="false"
        [resizable]="false"
        (onHide)="closeCreateModal()"
    >
        <div class="grid gap-4">
            <!-- Title -->
            <div class="col-12">
                <label for="title" class="block text-900 font-semibold mb-2">
                    <i class="pi pi-heading mr-2 text-primary"></i>Title
                    <span class="text-red-500">*</span>
                </label>
                <input
                    id="title"
                    type="text"
                    pInputText
                    [(ngModel)]="newJobPost.title"
                    placeholder="Enter job post title (5-200 characters)"
                    class="w-full"
                />
                <small class="text-600 block mt-1">
                    {{ newJobPost.title.length }}/200 characters
                </small>
            </div>

            <!-- Description -->
            <div class="col-12">
                <label for="description" class="block text-900 font-semibold mb-2">
                    <i class="pi pi-book mr-2 text-primary"></i>Description
                    <span class="text-red-500">*</span>
                </label>
                <textarea
                    id="description"
                    pInputTextarea
                    [(ngModel)]="newJobPost.description"
                    placeholder="Provide detailed job description (20-5000 characters)"
                    rows="6"
                    class="w-full"
                ></textarea>
                <small class="text-600 block mt-1">
                    {{ newJobPost.description.length }}/5000 characters
                </small>
            </div>

            <!-- Requirements -->
            <div class="col-12">
                <div class="flex align-items-center justify-content-between mb-3">
                    <label class="block text-900 font-semibold">
                        <i class="pi pi-list mr-2 text-primary"></i>Requirements
                        <span class="text-red-500">*</span>
                    </label>
                    <p-button
                        icon="pi pi-plus"
                        [rounded]="true"
                        [text]="true"
                        severity="success"
                        (onClick)="addRequirement()"
                        pTooltip="Add requirement"
                    ></p-button>
                </div>

                <div class="grid gap-3">
                    @for(requirement of newJobPost.requirements; track $index) {
                    <div class="col-12">
                        <div class="flex gap-2 align-items-end">
                            <div class="flex-grow-1">
                                <input
                                    type="text"
                                    pInputText
                                    [(ngModel)]="requirement.text"
                                    placeholder="Enter requirement"
                                    class="w-full"
                                />
                            </div>
                            <p-checkbox
                                [(ngModel)]="requirement.mandatory"
                                [binary]="true"
                                pTooltip="Mark as mandatory"
                                tooltipPosition="top"
                            ></p-checkbox>
                            @if(newJobPost.requirements.length > 1) {
                            <p-button
                                icon="pi pi-trash"
                                severity="danger"
                                [text]="true"
                                [rounded]="true"
                                (onClick)="removeRequirement($index)"
                                pTooltip="Remove requirement"
                            ></p-button>
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex gap-2 justify-content-end">
                <p-button
                    label="Cancel"
                    icon="pi pi-times"
                    severity="secondary"
                    (onClick)="closeCreateModal()"
                ></p-button>
                <p-button
                    label="Create Job Post"
                    icon="pi pi-check"
                    severity="success"
                    (onClick)="submitJobPost()"
                ></p-button>
            </div>
        </ng-template>
    </p-dialog>
</div>

<ngx-spinner
    bdColor="rgba(0, 0, 0, 0.8)"
    size="large"
    color="#ffd700"
    type="timer"
    [fullScreen]="true"
>
    <p style="color: #ffd700">Loading...</p>
</ngx-spinner>

<p-toast position="top-center" />
