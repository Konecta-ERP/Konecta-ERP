<p-toast></p-toast>
<div class="grid mb-4">
    <div class="col-12">
        <p-card
            styleClass="shadow-4 border-round-2xl h-full"
            [style]="{ background: 'linear-gradient(to right, #2563EB, #4F46E5)', color: 'white' }"
        >
            <div class="flex align-items-center gap-4 h-full p-4">
                <i class="pi pi-chart-line text-6xl"></i>
                <div>
                    <h2 class="text-3xl font-bold m-0 text-white">Financial Analytics</h2>
                    <p class="text-white-alpha-90 text-lg m-0 mt-2">
                        Balance Sheet, General Ledger, and Financial Reporting.
                    </p>
                </div>
            </div>
        </p-card>
    </div>
</div>

<div class="card" *ngIf="canView">
    <p-tabs value="0">
        <p-tablist>
            <p-tab value="0"> <i class="pi pi-building mr-2"></i> Balance Sheet </p-tab>
            <p-tab value="1"> <i class="pi pi-list mr-2"></i> General Ledger </p-tab>
            <p-tab value="2">
                <i class="pi pi-chart-bar mr-2"></i> Revenue Forecast
                <p-tag value="AI" severity="success" class="ml-2"></p-tag>
            </p-tab>
        </p-tablist>

        <p-tabpanels>
            <p-tabpanel value="0">
                <div class="flex flex-wrap align-items-end gap-3 mb-4 p-3 bg-blue-50 border-round">
                    <div class="flex-1">
                        <label class="block font-bold mb-2 text-700">As Of Date</label>
                        <p-datepicker
                            [(ngModel)]="bsDate"
                            dateFormat="yy-mm-dd"
                            [showIcon]="true"
                            styleClass="w-full"
                            [inputStyle]="{ width: '100%' }"
                        ></p-datepicker>
                    </div>
                    <div class="flex gap-2">
                        <button
                            pButton
                            label="Generate Report"
                            icon="pi pi-cog"
                            (click)="loadBalanceSheet()"
                        ></button>
                        <button
                            pButton
                            label="PDF"
                            icon="pi pi-file-pdf"
                            class="p-button-danger p-button-outlined"
                            (click)="exportBS('pdf')"
                            [disabled]="!bsReport"
                        ></button>
                        <button
                            pButton
                            label="Excel"
                            icon="pi pi-file-excel"
                            class="p-button-success p-button-outlined"
                            (click)="exportBS('excel')"
                            [disabled]="!bsReport"
                        ></button>
                    </div>
                </div>

                <div *ngIf="bsReport" class="fade-in">
                    <div class="flex justify-content-between align-items-center mb-3">
                        <span class="text-2xl font-bold text-900">Balance Sheet</span>
                        <p-tag
                            [value]="bsReport.validationStatus"
                            [severity]="
                                bsReport.validationStatus === 'Balanced' ? 'success' : 'danger'
                            "
                            class="text-lg"
                        ></p-tag>
                    </div>
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <p-panel header="Assets">
                                <div
                                    *ngFor="let row of bsReport.assetsCurrent"
                                    class="flex justify-content-between py-1 border-bottom-1 surface-border"
                                >
                                    <span>{{ row.accountName }}</span>
                                    <span class="font-medium">{{
                                        row.signedBalance | currency : 'USD'
                                    }}</span>
                                </div>
                                <div
                                    class="flex justify-content-between mt-4 pt-3 border-top-2 border-blue-600"
                                >
                                    <span class="text-xl font-bold">Total Assets</span>
                                    <span class="text-xl font-bold">{{
                                        bsReport.totalAssets | currency : 'USD'
                                    }}</span>
                                </div>
                            </p-panel>
                        </div>
                        <div class="col-12 md:col-6">
                            <p-panel header="Liabilities & Equity">
                                <div
                                    *ngFor="let row of bsReport.liabilitiesCurrent"
                                    class="flex justify-content-between py-1 border-bottom-1 surface-border"
                                >
                                    <span>{{ row.accountName }}</span>
                                    <span class="font-medium">{{
                                        row.signedBalance | currency : 'USD'
                                    }}</span>
                                </div>
                                <div
                                    class="flex justify-content-between mt-4 pt-3 border-top-2 border-orange-600"
                                >
                                    <span class="text-xl font-bold">Total Liab. & Equity</span>
                                    <span class="text-xl font-bold">{{
                                        bsReport.totalLiabilities + bsReport.totalEquity
                                            | currency : 'USD'
                                    }}</span>
                                </div>
                            </p-panel>
                        </div>
                    </div>
                </div>
            </p-tabpanel>

            <p-tabpanel value="1">
                <div class="flex flex-wrap align-items-end gap-3 mb-4 p-3 bg-blue-50 border-round">
                    <div class="flex-1">
                        <label class="block font-bold mb-2 text-700">From</label>
                        <p-datepicker
                            [(ngModel)]="glStartDate"
                            dateFormat="yy-mm-dd"
                            [showIcon]="true"
                            styleClass="w-full"
                            [inputStyle]="{ width: '100%' }"
                        ></p-datepicker>
                    </div>
                    <div class="flex-1">
                        <label class="block font-bold mb-2 text-700">To</label>
                        <p-datepicker
                            [(ngModel)]="glEndDate"
                            dateFormat="yy-mm-dd"
                            [showIcon]="true"
                            styleClass="w-full"
                            [inputStyle]="{ width: '100%' }"
                        ></p-datepicker>
                    </div>
                    <div class="flex gap-2">
                        <button
                            pButton
                            label="Generate GL"
                            icon="pi pi-search"
                            (click)="loadGL()"
                        ></button>
                    </div>
                </div>
                <p-table
                    *ngIf="glReport"
                    [value]="glReport.entries"
                    [paginator]="true"
                    [rows]="15"
                    styleClass="p-datatable-sm gridlines"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Date</th>
                            <th>Account</th>
                            <th>Description</th>
                            <th class="text-right">Debit</th>
                            <th class="text-right">Credit</th>
                            <th class="text-right">Balance</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-entry>
                        <tr>
                            <td>{{ entry.transactionDate | date }}</td>
                            <td class="font-bold">{{ entry.accountName }}</td>
                            <td>{{ entry.description }}</td>
                            <td class="text-right text-green-700">
                                <span *ngIf="entry.debitAmount > 0">{{
                                    entry.debitAmount | currency : 'USD'
                                }}</span>
                            </td>
                            <td class="text-right text-orange-700">
                                <span *ngIf="entry.creditAmount > 0">{{
                                    entry.creditAmount | currency : 'USD'
                                }}</span>
                            </td>
                            <td class="text-right font-bold">
                                {{ entry.runningBalance | currency : 'USD' }}
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>

            <p-tabpanel value="2">
                <div class="grid">
                    <div class="col-12 md:col-4">
                        <p-card header="Forecast Input" styleClass="h-full shadow-2">
                            <div class="flex flex-column gap-4">
                                <div class="field">
                                    <label class="font-bold block mb-2 text-700"
                                        >Revenue (2 Quarters Ago)</label
                                    >
                                    <p-inputNumber
                                        [(ngModel)]="revenueT2"
                                        mode="currency"
                                        currency="USD"
                                        locale="en-US"
                                        placeholder="$0.00"
                                        class="w-full"
                                        styleClass="w-full"
                                    ></p-inputNumber>
                                </div>
                                <div class="field">
                                    <label class="font-bold block mb-2 text-700"
                                        >Revenue (Last Quarter)</label
                                    >
                                    <p-inputNumber
                                        [(ngModel)]="revenueT1"
                                        mode="currency"
                                        currency="USD"
                                        locale="en-US"
                                        placeholder="$0.00"
                                        class="w-full"
                                        styleClass="w-full"
                                    ></p-inputNumber>
                                </div>
                                <button
                                    pButton
                                    label="Run AI Forecast"
                                    icon="pi pi-sparkles"
                                    class="p-button-primary w-full"
                                    [loading]="loading"
                                    (click)="runForecast()"
                                ></button>
                            </div>
                        </p-card>
                    </div>
                    <div class="col-12 md:col-8">
                        <p-card header="Projection Model" styleClass="h-full shadow-2">
                            <div
                                *ngIf="!prediction"
                                class="flex flex-column align-items-center justify-content-center h-20rem text-500"
                            >
                                <i class="pi pi-chart-line text-6xl mb-3"></i>
                                <span class="text-xl"
                                    >Enter historical data to generate a forecast.</span
                                >
                            </div>
                            <div *ngIf="prediction" class="fade-in">
                                <div class="text-center mb-5 p-4 surface-50 border-round-xl">
                                    <span class="block text-600 font-semibold mb-2"
                                        >Predicted Revenue (Next Quarter)</span
                                    >
                                    <span class="text-5xl font-bold text-green-600">{{
                                        prediction | currency : 'USD' : 'symbol' : '1.0-0'
                                    }}</span>
                                </div>
                                <div class="h-20rem w-full relative overflow-hidden">
                                    <p-chart
                                        type="line"
                                        [data]="chartData"
                                        [options]="chartOptions"
                                        width="100%"
                                        height="100%"
                                    >
                                    </p-chart>
                                </div>
                            </div>
                        </p-card>
                    </div>
                </div>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>
