<p-toast></p-toast>

<!-- Header -->
<div class="grid mb-4">
    <div class="col-12">
        <p-card
            styleClass="shadow-4 border-round-2xl h-full"
            [style]="{ background: 'linear-gradient(to right, #2563EB, #4F46E5)', color: 'white' }"
        >
            <div class="flex align-items-center gap-4 h-full p-4">
                <i class="pi pi-chart-line text-6xl"></i>
                <div>
                    <h2 class="text-3xl font-bold m-0 text-white">Financial Analytics</h2>
                    <p class="text-white-alpha-90 text-lg m-0 mt-2">
                        Balance Sheet, General Ledger, and Financial Reporting.
                    </p>
                </div>
            </div>
        </p-card>
    </div>
</div>

<div class="card" *ngIf="canView">
    <!-- Updated to new p-tabs structure -->
    <p-tabs [(value)]="activeTab">
        <p-tablist>
            <p-tab value="0">
                <i class="pi pi-building mr-2"></i>
                Balance Sheet
            </p-tab>
            <p-tab value="1">
                <i class="pi pi-list mr-2"></i>
                General Ledger
            </p-tab>
        </p-tablist>

        <p-tabpanels>
            <!-- TAB 1: BALANCE SHEET -->
            <p-tabpanel value="0">
                <!-- Toolbar -->
                <div class="flex flex-wrap align-items-end gap-3 mb-4 p-3 bg-blue-50 border-round">
                    <div class="flex-1">
                        <label class="block font-bold mb-2 text-700">As Of Date</label>
                        <p-datepicker
                            [(ngModel)]="bsDate"
                            dateFormat="yy-mm-dd"
                            [showIcon]="true"
                            styleClass="w-full"
                            [inputStyle]="{ width: '100%' }"
                        ></p-datepicker>
                    </div>
                    <div class="flex gap-2">
                        <button
                            pButton
                            label="Generate Report"
                            icon="pi pi-cog"
                            (click)="loadBalanceSheet()"
                        ></button>
                        <button
                            pButton
                            label="PDF"
                            icon="pi pi-file-pdf"
                            class="p-button-danger p-button-outlined"
                            (click)="exportBS('pdf')"
                            [disabled]="!bsReport"
                        ></button>
                        <button
                            pButton
                            label="Excel"
                            icon="pi pi-file-excel"
                            class="p-button-success p-button-outlined"
                            (click)="exportBS('excel')"
                            [disabled]="!bsReport"
                        ></button>
                    </div>
                </div>

                <!-- Report View -->
                <div *ngIf="bsReport" class="fade-in">
                    <div class="flex justify-content-between align-items-center mb-3">
                        <span class="text-2xl font-bold text-900">Balance Sheet</span>
                        <p-tag
                            [value]="bsReport.validationStatus"
                            [severity]="
                                bsReport.validationStatus === 'Balanced' ? 'success' : 'danger'
                            "
                            class="text-lg"
                        ></p-tag>
                    </div>

                    <div class="grid">
                        <!-- Assets Column -->
                        <div class="col-12 md:col-6">
                            <p-panel header="Assets" styleClass="mb-3">
                                <div class="font-bold text-lg mb-2 text-blue-600">
                                    Current Assets
                                </div>
                                <div
                                    *ngFor="let row of bsReport.assetsCurrent"
                                    class="flex justify-content-between py-1 border-bottom-1 surface-border"
                                >
                                    <span>{{ row.accountName }}</span>
                                    <span class="font-medium">{{
                                        row.signedBalance | currency : 'USD'
                                    }}</span>
                                </div>

                                <div class="font-bold text-lg mb-2 mt-4 text-blue-600">
                                    Non-Current Assets
                                </div>
                                <div
                                    *ngFor="let row of bsReport.assetsNonCurrent"
                                    class="flex justify-content-between py-1 border-bottom-1 surface-border"
                                >
                                    <span>{{ row.accountName }}</span>
                                    <span class="font-medium">{{
                                        row.signedBalance | currency : 'USD'
                                    }}</span>
                                </div>

                                <div
                                    class="flex justify-content-between mt-4 pt-3 border-top-2 border-blue-600"
                                >
                                    <span class="text-xl font-bold">Total Assets</span>
                                    <span class="text-xl font-bold">{{
                                        bsReport.totalAssets | currency : 'USD'
                                    }}</span>
                                </div>
                            </p-panel>
                        </div>

                        <!-- Liabilities & Equity Column -->
                        <div class="col-12 md:col-6">
                            <p-panel header="Liabilities & Equity">
                                <div class="font-bold text-lg mb-2 text-orange-600">
                                    Current Liabilities
                                </div>
                                <div
                                    *ngFor="let row of bsReport.liabilitiesCurrent"
                                    class="flex justify-content-between py-1 border-bottom-1 surface-border"
                                >
                                    <span>{{ row.accountName }}</span>
                                    <span class="font-medium">{{
                                        row.signedBalance | currency : 'USD'
                                    }}</span>
                                </div>

                                <div class="font-bold text-lg mb-2 mt-4 text-orange-600">
                                    Non-Current Liabilities
                                </div>
                                <div
                                    *ngFor="let row of bsReport.liabilitiesNonCurrent"
                                    class="flex justify-content-between py-1 border-bottom-1 surface-border"
                                >
                                    <span>{{ row.accountName }}</span>
                                    <span class="font-medium">{{
                                        row.signedBalance | currency : 'USD'
                                    }}</span>
                                </div>

                                <div class="font-bold text-lg mb-2 mt-4 text-green-600">Equity</div>
                                <div
                                    *ngFor="let row of bsReport.equity"
                                    class="flex justify-content-between py-1 border-bottom-1 surface-border"
                                >
                                    <span>{{ row.accountName }}</span>
                                    <span class="font-medium">{{
                                        row.signedBalance | currency : 'USD'
                                    }}</span>
                                </div>

                                <div
                                    class="flex justify-content-between mt-4 pt-3 border-top-2 border-orange-600"
                                >
                                    <span class="text-xl font-bold">Total Liab. & Equity</span>
                                    <span class="text-xl font-bold">{{
                                        bsReport.totalLiabilities + bsReport.totalEquity
                                            | currency : 'USD'
                                    }}</span>
                                </div>
                            </p-panel>
                        </div>
                    </div>
                </div>
            </p-tabpanel>

            <!-- TAB 2: GENERAL LEDGER -->
            <p-tabpanel value="1">
                <!-- Toolbar -->
                <div class="flex flex-wrap align-items-end gap-3 mb-4 p-3 bg-blue-50 border-round">
                    <div class="flex-1">
                        <label class="block font-bold mb-2 text-700">From Date</label>
                        <p-datepicker
                            [(ngModel)]="glStartDate"
                            dateFormat="yy-mm-dd"
                            [showIcon]="true"
                            styleClass="w-full"
                            [inputStyle]="{ width: '100%' }"
                        ></p-datepicker>
                    </div>
                    <div class="flex-1">
                        <label class="block font-bold mb-2 text-700">To Date</label>
                        <p-datepicker
                            [(ngModel)]="glEndDate"
                            dateFormat="yy-mm-dd"
                            [showIcon]="true"
                            styleClass="w-full"
                            [inputStyle]="{ width: '100%' }"
                        ></p-datepicker>
                    </div>
                    <div class="flex gap-2">
                        <button
                            pButton
                            label="Generate GL"
                            icon="pi pi-search"
                            (click)="loadGL()"
                        ></button>
                        <button
                            pButton
                            label="PDF"
                            icon="pi pi-file-pdf"
                            class="p-button-danger p-button-outlined"
                            (click)="exportGL('pdf')"
                            [disabled]="!glReport"
                        ></button>
                        <button
                            pButton
                            label="Excel"
                            icon="pi pi-file-excel"
                            class="p-button-success p-button-outlined"
                            (click)="exportGL('excel')"
                            [disabled]="!glReport"
                        ></button>
                    </div>
                </div>

                <!-- GL Table -->
                <p-table
                    *ngIf="glReport"
                    [value]="glReport.entries"
                    [paginator]="true"
                    [rows]="15"
                    styleClass="p-datatable-sm gridlines"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Date</th>
                            <th>Transaction ID</th>
                            <th>Account</th>
                            <th>Description</th>
                            <th class="text-right">Debit</th>
                            <th class="text-right">Credit</th>
                            <th class="text-right font-bold">Balance</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-entry>
                        <tr>
                            <td>{{ entry.transactionDate | date }}</td>
                            <td>#{{ entry.transactionId }}</td>
                            <td class="font-bold">{{ entry.accountName }}</td>
                            <td>{{ entry.description }}</td>
                            <td class="text-right text-green-700">
                                <span *ngIf="entry.debitAmount > 0">{{
                                    entry.debitAmount | currency : 'USD'
                                }}</span>
                            </td>
                            <td class="text-right text-orange-700">
                                <span *ngIf="entry.creditAmount > 0">{{
                                    entry.creditAmount | currency : 'USD'
                                }}</span>
                            </td>
                            <td class="text-right font-bold">
                                {{ entry.runningBalance | currency : 'USD' }}
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>
