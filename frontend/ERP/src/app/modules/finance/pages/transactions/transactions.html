<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<!-- Header -->
<div class="grid mb-4">
    <div class="col-12">
        <p-card
            styleClass="shadow-4 border-round-2xl h-full"
            [style]="{ background: 'linear-gradient(to right, #2563EB, #4F46E5)', color: 'white' }"
        >
            <div class="flex align-items-center gap-4 h-full p-4">
                <i class="pi pi-book text-6xl"></i>
                <div>
                    <h2 class="text-3xl font-bold m-0 text-white">General Journal</h2>
                    <p class="text-white-alpha-90 text-lg m-0 mt-2">
                        Record manual journal entries, accruals, and adjustments.
                    </p>
                </div>
            </div>
        </p-card>
    </div>
</div>

<!-- Main List Card -->
<p-card styleClass="shadow-4 border-round-2xl">
    <div class="p-3">
        <!-- Toolbar -->
        <p-toolbar styleClass="mb-4 gap-2 border-none bg-transparent px-0">
            <ng-template pTemplate="left">
                <button
                    *ngIf="canCreate"
                    pButton
                    pRipple
                    label="New Journal Entry"
                    icon="pi pi-plus"
                    class="p-button-success"
                    (click)="openNew()"
                ></button>
            </ng-template>
            <ng-template pTemplate="right">
                <button
                    pButton
                    pRipple
                    icon="pi pi-refresh"
                    class="p-button-text"
                    (click)="loadData()"
                ></button>
            </ng-template>
        </p-toolbar>

        <!-- Filter Row (Restored) -->
        <div class="flex flex-wrap align-items-end gap-3 mb-4 p-3 bg-blue-50 border-round">
            <div class="flex-1">
                <label for="startDate" class="block font-bold mb-2 text-sm text-700"
                    >Start Date</label
                >
                <p-datepicker
                    [(ngModel)]="filterStartDate"
                    inputId="startDate"
                    dateFormat="yy-mm-dd"
                    [showIcon]="true"
                    placeholder="Select Start Date"
                    styleClass="w-full"
                    [inputStyle]="{ width: '100%' }"
                ></p-datepicker>
            </div>
            <div class="flex-1">
                <label for="endDate" class="block font-bold mb-2 text-sm text-700">End Date</label>
                <p-datepicker
                    [(ngModel)]="filterEndDate"
                    inputId="endDate"
                    dateFormat="yy-mm-dd"
                    [showIcon]="true"
                    placeholder="Select End Date"
                    styleClass="w-full"
                    [inputStyle]="{ width: '100%' }"
                ></p-datepicker>
            </div>
            <div class="flex gap-2">
                <button
                    pButton
                    pRipple
                    label="Filter"
                    icon="pi pi-filter"
                    class="p-button-primary"
                    (click)="loadData()"
                ></button>
                <button
                    pButton
                    pRipple
                    label="Clear"
                    icon="pi pi-filter-slash"
                    class="p-button-outlined p-button-secondary"
                    (click)="clearFilter()"
                ></button>
            </div>
        </div>

        <!-- Transactions Table -->
        <p-table
            #dt
            [value]="transactions"
            [rows]="10"
            [paginator]="true"
            [globalFilterFields]="['description', 'transactionDate']"
            styleClass="p-datatable-lg"
            [tableStyle]="{ 'min-width': '60rem' }"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="transactionDate">
                        Date <p-sortIcon field="transactionDate"></p-sortIcon>
                    </th>
                    <th pSortableColumn="transactionId">
                        ID <p-sortIcon field="transactionId"></p-sortIcon>
                    </th>
                    <th pSortableColumn="description">
                        Explanation <p-sortIcon field="description"></p-sortIcon>
                    </th>
                    <th class="text-center">Details</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-tx>
                <tr>
                    <td class="py-3 font-bold">{{ tx.transactionDate | date : 'mediumDate' }}</td>
                    <td class="py-3">#{{ tx.transactionId }}</td>
                    <td class="py-3 text-700">{{ tx.description }}</td>
                    <td class="text-center">
                        <button
                            pButton
                            pRipple
                            icon="pi pi-eye"
                            class="p-button-rounded p-button-info p-button-text"
                            (click)="viewDetails(tx)"
                            pTooltip="View Journal Details"
                        ></button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-card>

<!-- View Details Dialog -->
<p-dialog
    [(visible)]="viewDetailsDialog"
    [style]="{ width: '800px' }"
    header="Transaction Details"
    [modal]="true"
    styleClass="p-fluid"
>
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-2 mb-4 p-3 bg-blue-50 border-round">
            <div class="flex justify-content-between">
                <span class="font-bold text-700">Transaction ID:</span>
                <span>#{{ selectedTransaction.transactionId }}</span>
            </div>
            <div class="flex justify-content-between">
                <span class="font-bold text-700">Date:</span>
                <span>{{ selectedTransaction.transactionDate | date : 'mediumDate' }}</span>
            </div>
            <div class="flex justify-content-between">
                <span class="font-bold text-700">Description:</span>
                <span>{{ selectedTransaction.description }}</span>
            </div>
        </div>

        <p-table
            [value]="selectedTransaction.entries || []"
            styleClass="p-datatable-gridlines shadow-1 border-round"
        >
            <ng-template pTemplate="header">
                <tr class="bg-gray-50">
                    <th style="width: 50%; padding: 1rem">Account Name</th>
                    <th class="text-right" style="width: 25%; padding: 1rem">Debit</th>
                    <th class="text-right" style="width: 25%; padding: 1rem">Credit</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-entry>
                <tr>
                    <td style="padding: 1rem" class="font-medium text-900">
                        {{ entry.accountName }}
                    </td>
                    <td class="text-right" style="padding: 1rem">
                        <span *ngIf="entry.debitAmount > 0" class="text-green-700 font-bold">{{
                            entry.debitAmount | currency : 'USD'
                        }}</span>
                    </td>
                    <td class="text-right" style="padding: 1rem">
                        <span *ngIf="entry.creditAmount > 0" class="text-orange-700 font-bold">{{
                            entry.creditAmount | currency : 'USD'
                        }}</span>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </ng-template>
    <ng-template pTemplate="footer">
        <button
            pButton
            pRipple
            label="Close"
            icon="pi pi-times"
            class="p-button-text"
            (click)="viewDetailsDialog = false"
        ></button>
    </ng-template>
</p-dialog>

<!-- New Transaction Dialog (Fixed Alignment & No Grey Block) -->
<p-dialog
    [(visible)]="transactionDialog"
    [style]="{ width: '900px' }"
    header="New Journal Entry"
    [modal]="true"
    styleClass="p-fluid"
>
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4 mb-5">
            <div class="flex gap-3">
                <div class="flex-1">
                    <label for="date" class="font-bold block mb-2">Transaction Date</label>
                    <p-datepicker
                        [(ngModel)]="transactionDate"
                        inputId="date"
                        dateFormat="yy-mm-dd"
                        appendTo="body"
                        [showIcon]="true"
                        styleClass="w-full"
                        [inputStyle]="{ width: '100%' }"
                    ></p-datepicker>
                </div>
                <div class="flex-2">
                    <label for="desc" class="font-bold block mb-2">Description</label>
                    <input
                        type="text"
                        pInputText
                        id="desc"
                        [(ngModel)]="description"
                        placeholder="e.g. Monthly Rent Accrual"
                        required
                        class="w-full"
                    />
                </div>
            </div>
        </div>

        <!-- Clean Header without extra wrappers -->
        <div
            class="flex justify-content-between align-items-center mb-3 border-bottom-1 surface-border pb-2"
        >
            <h3 class="m-0 font-bold text-xl text-900">Journal Lines</h3>
            <button
                pButton
                label="Add Line"
                icon="pi pi-plus"
                class="p-button-sm p-button-outlined p-button-success"
                (click)="addLine()"
            ></button>
        </div>

        <!-- Header Row -->
        <div class="grid font-bold mb-2 px-2 text-700 text-lg">
            <div class="col-5">Account</div>
            <div class="col-3">Debit</div>
            <div class="col-3">Credit</div>
            <div class="col-1"></div>
        </div>

        <!-- Dynamic Rows (Flex layout for perfect vertical centering) -->
        <div
            *ngFor="let entry of journalEntries; let i = index"
            class="grid align-items-center mb-3 px-2"
        >
            <!-- Account Selection -->
            <div class="col-5">
                <p-select
                    [options]="accounts"
                    [(ngModel)]="entry.accountPK"
                    optionLabel="accountName"
                    optionValue="accountPK"
                    appendTo="body"
                    placeholder="Select Account"
                    [filter]="true"
                    filterBy="accountName"
                    styleClass="w-full"
                ></p-select>
            </div>
            <!-- Debit Input -->
            <div class="col-3">
                <p-inputNumber
                    [(ngModel)]="entry.debitAmount"
                    mode="currency"
                    currency="USD"
                    locale="en-US"
                    [disabled]="entry.creditAmount > 0"
                    styleClass="w-full"
                    placeholder="$0.00"
                ></p-inputNumber>
            </div>
            <!-- Credit Input -->
            <div class="col-3">
                <p-inputNumber
                    [(ngModel)]="entry.creditAmount"
                    mode="currency"
                    currency="USD"
                    locale="en-US"
                    [disabled]="entry.debitAmount > 0"
                    styleClass="w-full"
                    placeholder="$0.00"
                ></p-inputNumber>
            </div>
            <!-- Remove Button (Vertically Centered) -->
            <div class="col-1 flex justify-content-center">
                <button
                    pButton
                    icon="pi pi-trash"
                    class="p-button-text p-button-danger p-button-rounded"
                    (click)="removeLine(i)"
                    pTooltip="Remove Line"
                    style="margin-top: 0"
                ></button>
            </div>
        </div>

        <!-- Footer Totals -->
        <div class="flex justify-content-end mt-4 gap-6 pr-6 border-top-1 surface-border pt-3">
            <div class="text-right">
                <div class="text-500 mb-1 text-sm uppercase font-semibold">Total Debits</div>
                <div class="font-bold text-2xl text-green-600">
                    {{ totalDebits | currency : 'USD' }}
                </div>
            </div>
            <div class="text-right">
                <div class="text-500 mb-1 text-sm uppercase font-semibold">Total Credits</div>
                <div class="font-bold text-2xl text-orange-600">
                    {{ totalCredits | currency : 'USD' }}
                </div>
            </div>
        </div>

        <!-- Balance Indicator -->
        <div
            *ngIf="!isBalanced"
            class="mt-3 p-3 border-round bg-red-50 text-red-700 flex align-items-center justify-content-center border-1 border-red-200"
        >
            <i class="pi pi-exclamation-circle mr-2 text-xl"></i>
            <span class="font-bold"
                >Entry is unbalanced. Difference:
                {{ totalDebits - totalCredits | currency : 'USD' }}</span
            >
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <button
            pButton
            pRipple
            label="Cancel"
            icon="pi pi-times"
            class="p-button-text"
            (click)="transactionDialog = false"
        ></button>
        <button
            pButton
            pRipple
            label="Post Journal"
            icon="pi pi-check"
            class="p-button-primary"
            (click)="saveTransaction()"
            [disabled]="!isBalanced || totalDebits === 0"
        ></button>
    </ng-template>
</p-dialog>
